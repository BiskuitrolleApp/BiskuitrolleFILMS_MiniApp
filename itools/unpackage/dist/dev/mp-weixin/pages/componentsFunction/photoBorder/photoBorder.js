require('../common/vendor.js');(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/componentsFunction/photoBorder/photoBorder"],{166:function(e,t,n){"use strict";(function(e){n(5);o(n(3));var t=o(n(167));function o(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=n,e(t.default)}).call(this,n(1)["createPage"])},167:function(e,t,n){"use strict";n.r(t);var o=n(168),i=n(170);for(var a in i)"default"!==a&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n(177);var r,c=n(11),s=Object(c["default"])(i["default"],o["render"],o["staticRenderFns"],!1,null,"35a066a5",null,!1,o["components"],r);s.options.__file="pages/componentsFunction/photoBorder/photoBorder.vue",t["default"]=s.exports},168:function(e,t,n){"use strict";n.r(t);var o=n(169);n.d(t,"render",(function(){return o["render"]})),n.d(t,"staticRenderFns",(function(){return o["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return o["recyclableRender"]})),n.d(t,"components",(function(){return o["components"]}))},169:function(e,t,n){"use strict";var o;n.r(t),n.d(t,"render",(function(){return i})),n.d(t,"staticRenderFns",(function(){return r})),n.d(t,"recyclableRender",(function(){return a})),n.d(t,"components",(function(){return o}));try{o={uButton:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-button/u-button")]).then(n.bind(null,938))}}}catch(c){if(-1===c.message.indexOf("Cannot find module")||-1===c.message.indexOf(".vue"))throw c;console.error(c.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var e=this,t=e.$createElement;e._self._c},a=!1,r=[];i._withStripped=!0},170:function(e,t,n){"use strict";n.r(t);var o=n(171),i=n.n(o);for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=i.a},171:function(e,t,n){"use strict";(function(e,o){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(36)),a=n(174),r=f(n(175)),c=n(13),s=(n(176),f(n(138)));function f(e){return e&&e.__esModule?e:{default:e}}function h(e,t,n,o,i,a,r){try{var c=e[a](r),s=c.value}catch(f){return void n(f)}c.done?t(s):Promise.resolve(s).then(o,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function r(e){h(a,o,i,r,c,"next",e)}function c(e){h(a,o,i,r,c,"throw",e)}r(void 0)}))}}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){m(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}e.loadFontFace({global:!0,family:"gilmerRegular",source:'url("https://vkceyugu.cdn.bspapp.com/VKCEYUGU-915d01a8-6118-4e1e-840f-697d960cbba2/fb5d1790-57b8-4ae5-a1ab-f6bf975ea055.otf")',scopes:["webview","native"],success:function(e){console.log("字体加载完成")},fail:function(e){console.log("字体加载失败",e)}});var d={data:function(){return{saveImgUrl:"",photoConfigData:[],defaultLogo:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-915d01a8-6118-4e1e-840f-697d960cbba2/707e5b40-8353-401d-8b20-f20679182fa4.png",photoExifInfo:{},userInfo:{},photoDrawList:[],canvasConfig:{maxCanvasSize:320,maxCanvasInfoWrapperSize:50,scale:1},photoDrawInfo:{width:320,height:240,background:"#fff",mainImage:{scale:1,customAngle:0,position:"center",content:"",originWidth:100,originHeight:100,width:100,height:100,xAxis:0,yAxis:0,angle:0},EXIFInfo:{InfoWrapperHeight:30,fontStyle:"",fontColor:"#000000",color:"#9f9f9f",fontSize:10,secondFontSize:8,imgInfo:{xAxis:0,yAxis:0,content:"",fontStyle:"",fontColor:"#000000",fontSize:10},machineName:{xAxis:0,yAxis:0,content:"",fontStyle:"",fontColor:"#000000",fontSize:10},time:{xAxis:0,yAxis:0,content:"",fontStyle:"",fontColor:"#9f9f9f",fontSize:8},authorName:{xAxis:0,yAxis:0,content:"",fontStyle:"",fontColor:"#9f9f9f",fontSize:8},brandLogo:{xAxis:320,yAxis:320,content:"",xPosition:"center",yPosition:"center"}}}}},mounted:function(){this.getPhotoConfigList()},methods:g(g({},(0,c.mapMutations)(["setUserInfo"])),{},{getPhotoConfigList:function(){var t=this,n=o.database();n.collection("photoBorder-config-list").get().then((function(e){var n=e.result;console.log("配置加载完成"),t.photoConfigData=n.data})).catch((function(n){t.photoConfigData=[],e.showToast({icon:"error",duration:1e3,title:"配置加载失败"})}))},onUpdatedFile:function(){var t=this;return l(i.default.mark((function n(){var o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=t,n.prev=1,n.next=4,o.getUserInfo();case 4:return n.next=6,e.chooseImage({sizeType:["original"],success:function(){var t=l(i.default.mark((function t(n){var r;return i.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.showLoading({title:"开始绘制"}),r=n.tempFilePaths[0],o.photoDrawInfo.mainImage.content=r,t.next=5,o.getCanvasSize(r);case 5:setTimeout((function(){(0,a.getImageData)(r).then((function(e){o.photoExifInfo=e.exif,o.initExifCanvasInfo(e.exif),o.startDraw()})).catch((function(e){console.log("getImageData error",e),o.startDraw()}))}),1e3);case 6:case"end":return t.stop()}}),t)})));function n(e){return t.apply(this,arguments)}return n}()});case 6:e.hideLoading(),n.next=13;break;case 9:n.prev=9,n.t0=n["catch"](1),e.showToast({duration:1e3,title:"需要使用用户信息"}),e.hideLoading();case 13:case"end":return n.stop()}}),n,null,[[1,9]])})))()},initExifCanvasInfo:function(t){var n=this;console.log("initExifCanvasInfo"),t.FNumber&&t.ExposureTime&&t.FocalLength&&t.Make&&t.Model||e.showToast({icon:"error",duration:1e3,title:"识别失败"}),this.photoDrawInfo.EXIFInfo.brandLogo.content=t.Make||"",this.photoDrawInfo.EXIFInfo.machineName.content=t.Model||"",this.photoDrawInfo.EXIFInfo.time.content=t.DateTimeOriginal||"",this.photoDrawInfo.EXIFInfo.authorName.content="PHOTO BY @"+n.userInfo.nickName;var o=(t.FocalLength.numerator/t.FocalLength.denominator||"?")+"mm ",i="f/"+(t.FNumber.numerator/t.FNumber.denominator||"?")+" ",a=(t.ExposureTime.numerator+"/"+t.ExposureTime.denominator||"?")+" ",r="ISO"+(t.ISOSpeedRatings||"?")+" ";this.photoDrawInfo.EXIFInfo.imgInfo.content=o+i+a+r},startDraw:function(){var t=this;return l(i.default.mark((function n(){var o,a,r,c,s,f,h,l,u,g,m,d,p,I,w,v,x,b,y,S,D,T,A,C,F,N,O;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=t,console.log("开始绘制"),a=t.photoDrawInfo,r=a.mainImage,c=a.EXIFInfo,console.log("this.photoDrawInfo",JSON.stringify(t.photoDrawInfo)),s=e.createCanvasContext("canvas"),console.log("cavans宽高：",a.width,a.height),s.width=a.width,s.height=a.height,s.clearRect(0,0,1e3,1e3),s.setFillStyle(a.background),s.fillRect(0,0,1e3,1e3),s.drawImage(r.content,r.xAxis,r.yAxis,r.width,r.height),f=8,h=0,l=15,u="gilmerRegular",g=5,m=f+c.machineName.xAxis,d=h+r.height,t.drawText(s,c.machineName.content,c.machineName.fontSize,c.machineName.fontColor,m,d,200,!0,"",u),p=f+c.authorName.xAxis,I=h+c.authorName.yAxis+r.height+l,t.drawText(s,c.authorName.content,c.authorName.fontSize,c.authorName.fontColor,p,I,200,!1,"",u),n.next=26,t.getTextWidth(s,c.time.content,!0,c.time.fontSize,u);case 26:return w=n.sent,n.next=29,t.getTextWidth(s,c.imgInfo.content,!1,c.imgInfo.fontSize,u);case 29:for(v=n.sent,x=w>=v?w:v,console.log("rightWidth",x,r.width),b=r.width-f-x+c.imgInfo.xAxis,y=h+c.imgInfo.yAxis+r.height,t.drawText(s,c.imgInfo.content,c.imgInfo.fontSize,c.imgInfo.fontColor,b,y,200,!0,"",u),S=r.width-f-x+c.time.xAxis,D=h+c.time.yAxis+r.height+l,t.drawText(s,c.time.content,c.time.fontSize,c.time.fontColor,S,D,200,!1,"",u),T=(c.InfoWrapperHeight+c.time.fontSize+c.imgInfo.fontSize)/2,A=r.width-f-x-g,C=r.height+(c.InfoWrapperHeight-T)/2,s.moveTo(A,C),s.lineTo(A,T+C),s.strokeStyle=c.color,s.lineJoin="round",s.lineWidth=.5,s.stroke(),F="",N="",O=0;O<t.photoConfigData.length;O++)"default"==t.photoConfigData[O].photo_name&&(N=t.photoConfigData[O].photo_url),!t.photoDrawInfo.EXIFInfo.brandLogo.content&&t.photoDrawInfo.EXIFInfo.brandLogo.content.toLowerCase().indexOf(t.photoConfigData[O].photo_name)>=0&&(F=t.photoConfigData[O].photo_url);F&&""!=F?F&&""!=F||N&&""!=N||(F=t.defaultLogo):F=N,console.log("logoImg",F,T),e.getImageInfo({src:F,success:function(t){console.log("logo width",t.width),console.log("logo height",t.height);var n=o.calculationImageScaleSize({width:t.width,height:t.height},T,"height"),i=r.width-f-x-2*g-n.width,a=r.height+(c.InfoWrapperHeight-T)/2;s.drawImage(t.path,i,a,n.width,n.height),s.draw(),console.log("结束绘制"),e.hideLoading()}});case 53:case"end":return n.stop()}}),n)})))()},getUserInfo:function(){var e=this,t={avatarUrl:"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIpibGEFzIzodVfuJib3BOlRIvMRHFGCTia69TFvZBB69msSJcp45dvtmv6qYibdiahcs2bDTIg5MoBWNA/132",city:"",country:"",gender:0,language:"zh_CN",nickName:"KaiJie Tee",province:""};e.userInfo=t,this.setUserInfo(t)},drawText:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:12,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#000",i=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:999,c=arguments.length>7?arguments[7]:void 0,s=arguments.length>8?arguments[8]:void 0,f=arguments.length>9?arguments[9]:void 0;if(e.font=c?"bold ".concat(n,"px ").concat(f||"normal"):"normal ".concat(n,"px  ").concat(f||"normal"),e.textAlign=s||"left",e.fillStyle=o,e.textBaseline="middle",console.log("drawText",n,Number(a)+Number(n)),e.measureText(t).width>r){var h=1;while(e.measureText(t.slice(0,t.length-h)).width>693)h++;e.fillText(t.slice(0,t.length-(h+1))+"...",i,Number(a)+Number(n))}else e.fillText(t,i,Number(a)+Number(n))},getCanvasSize:function(){var t=arguments,n=this;return l(i.default.mark((function o(){var a,c;return i.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(a=t.length>0&&void 0!==t[0]?t[0]:"",console.log("getCanvasSize"),c=n,""!=a){o.next=5;break}throw"文件格式错误";case 5:return o.prev=5,o.next=8,e.getImageInfo({src:a,success:function(e){console.log("width",e.width),console.log("height",e.height),c.photoDrawInfo.width=320,c.photoDrawInfo.height=r.default.formatNumber(r.default.formatDecimal(e.height/e.width*320,2))+c.photoDrawInfo.EXIFInfo.InfoWrapperHeight,c.getImageSize(e.width,e.height)}});case 8:o.next=13;break;case 10:o.prev=10,o.t0=o["catch"](5),console.log("error",o.t0);case 13:case"end":return o.stop()}}),o,null,[[5,10]])})))()},calculationImageScaleSize:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"width",o=e.width,i=e.height;return"width"==n?(o=t,i=r.default.formatNumber(r.default.formatDecimal(e.height/e.width*t,2))):(i=t,o=r.default.formatNumber(r.default.formatDecimal(e.width/e.height*t,2))),{width:o,height:i}},getImageSize:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=s.default.cloneDeep(this.photoDrawInfo);if(e&&t){var o=this.calculationImageScaleSize({width:e,height:t},320);n.mainImage.originWidth=o.width,n.mainImage.originHeight=o.height}var i=n.mainImage.originWidth,a=n.mainImage.originHeight;if(n.mainImage.width=n.mainImage.scale*n.mainImage.originWidth,n.mainImage.height=n.mainImage.scale*n.mainImage.originHeight,n.mainImage.xAxis=0,n.mainImage.yAxis=0,!n.mainImage.customXAxis&&!n.mainImage.customXAxis){var r=(i-n.mainImage.width)/2,c=(a-n.mainImage.height)/2,f=r>=c?r:c;"left"==n.mainImage.position?(n.mainImage.yAxis=f,n.mainImage.xAxis=0):"right"==n.mainImage.position?(n.mainImage.yAxis=f,n.mainImage.xAxis=2*f):"top"==n.mainImage.position?(n.mainImage.yAxis=0,n.mainImage.xAxis=f):"bottom"==n.mainImage.position?(n.mainImage.yAxis=2*f,n.mainImage.xAxis=f):(n.mainImage.yAxis=f,n.mainImage.xAxis=f);var h=Math.abs(r-c);r>c?n.height+=2*h:n.width+=2*h}n.mainImage.angle=n.mainImage.customAngle,this.photoDrawInfo=n,console.log("photoDrawInfo",JSON.stringify(n))},getTextWidth:function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12,i=arguments.length>4?arguments[4]:void 0;return e.font=n?"bold ".concat(o,"px ").concat(i||"normal"):"normal ".concat(o,"px  ").concat(i||"normal"),e.measureText(t).width},saveImage:function(){var t=this.photoDrawInfo;e.canvasToTempFilePath({x:0,y:0,width:t.width,height:t.height,destWidth:t.width,destHeight:t.height,canvasId:"canvas",success:function(t){e.saveImageToPhotosAlbum({filePath:t.tempFilePath,success:function(){e.showToast({title:"图片已保存图片到相册",icon:"none",duration:2e3})},fail:function(){e.hideLoading(),e.showModal({content:"检测到您没打开获取信息功能权限，是否去设置打开？",confirmText:"确认",cancelText:"取消",success:function(t){t.confirm?e.openSetting({success:function(t){console.log(t),e.showToast({title:"请重新点击分享保存图片～",icon:"none"})}}):e.showToast({title:"保存失败，请打开权限功能重试",icon:"none"})}})}})},fail:function(e){console.log(e)}})}})};t.default=d}).call(this,n(1)["default"],n(172)["default"])},177:function(e,t,n){"use strict";n.r(t);var o=n(178),i=n.n(o);for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=i.a},178:function(e,t,n){}},[[166,"common/runtime","common/vendor","pages/componentsFunction/common/vendor"]]]);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pages/componentsFunction/photoBorder/photoBorder.js.map